doctype html
html(lang="zh-TW")
  head
    meta(charset="UTF-8")
    meta(name="viewport" content="width=device-width, initial-scale=1.0")
    title Piano Rhythm Game - 落下音符鋼琴遊戲

    style(type="text/css"): :stylus
      *
        margin: 0
        padding: 0
        box-sizing: border-box

      body
        font-family: 'Arial', sans-serif
        background: #0a0a0f
        background-image:
          radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
          radial-gradient(circle at 80% 80%, rgba(255, 119, 255, 0.1) 0%, transparent 50%)
        min-height: 100vh
        display: flex
        flex-direction: column
        align-items: center
        justify-content: center
        color: #fff
        overflow: hidden

      .container
        width: 95%
        max-width: 1400px
        margin: 20px auto

      h1
        text-align: center
        margin-bottom: 20px
        font-size: 2.5em
        text-shadow: 0 0 20px rgba(120, 119, 198, 0.8), 0 0 40px rgba(120, 119, 198, 0.4)
        background: linear-gradient(45deg, #7877c6, #ff77ff)
        -webkit-background-clip: text
        background-clip: text
        -webkit-text-fill-color: transparent

      .controls
        text-align: center
        margin-bottom: 20px

        button
          padding: 12px 30px
          margin: 0 10px
          font-size: 16px
          border: 2px solid #7877c6
          border-radius: 8px
          background: rgba(120, 119, 198, 0.2)
          color: #fff
          cursor: pointer
          font-weight: bold
          transition: all 0.3s
          box-shadow: 0 0 20px rgba(120, 119, 198, 0.3)

          &:hover
            background: rgba(120, 119, 198, 0.4)
            box-shadow: 0 0 30px rgba(120, 119, 198, 0.6)
            transform: translateY(-2px)

          &:active
            transform: translateY(0)
            box-shadow: 0 0 15px rgba(120, 119, 198, 0.5)

      .score-display
        text-align: center
        margin-bottom: 20px
        font-size: 1.2em
        background: rgba(0,0,0,0.4)
        border: 1px solid rgba(120, 119, 198, 0.3)
        padding: 15px
        border-radius: 10px
        backdrop-filter: blur(10px)
        position: relative
        min-height: 80px
        box-shadow: 0 0 30px rgba(120, 119, 198, 0.2)

        .score-item
          margin: 5px 0

        .perfect
          color: #4ade80

        .good
          color: #fbbf24

        .miss
          color: #f87171

      .judgment
        position: absolute
        top: 50%
        left: 50%
        transform: translate(-50%, -50%)
        font-size: 2em
        font-weight: bold
        animation: judgment-fade 0.5s ease-out
        pointer-events: none
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5)

        &.judgment-perfect
          color: #4ade80

        &.judgment-good
          color: #fbbf24

        &.judgment-miss
          color: #f87171

      @keyframes judgment-fade
        0%
          opacity: 1
          transform: translate(-50%, -50%) scale(1)
        100%
          opacity: 0
          transform: translate(-50%, -70%) scale(1.5)

      @keyframes note-glow
        0%
          box-shadow:
            0 0 20px rgba(120, 119, 198, 0.6),
            0 0 40px rgba(120, 119, 198, 0.3),
            inset 0 0 20px rgba(255,255,255,0.2)
        100%
          box-shadow:
            0 0 30px rgba(120, 119, 198, 0.9),
            0 0 60px rgba(120, 119, 198, 0.5),
            inset 0 0 30px rgba(255,255,255,0.3)

      @keyframes hit-burst
        0%
          opacity: 1
          transform: scale(0.5)
        100%
          opacity: 0
          transform: scale(2)

      .hit-effect
        position: absolute
        width: 80px
        height: 80px
        border-radius: 50%
        background: radial-gradient(circle, rgba(120, 119, 198, 0.6) 0%, transparent 70%)
        pointer-events: none
        animation: hit-burst 0.6s ease-out
        box-shadow: 0 0 40px rgba(120, 119, 198, 0.8)

      .hit-particle
        position: absolute
        width: 4px
        height: 4px
        background: #7877c6
        border-radius: 50%
        pointer-events: none
        box-shadow: 0 0 10px rgba(120, 119, 198, 0.8)

      .game-area
        background: rgba(0,0,0,0.6)
        border: 1px solid rgba(120, 119, 198, 0.3)
        border-radius: 15px
        padding: 20px
        box-shadow: 0 0 50px rgba(120, 119, 198, 0.3)
        backdrop-filter: blur(10px)

      .note-area
        position: relative
        width: 100%
        min-width: 1320px
        height: 500px
        background: rgba(0,0,0,0.5)
        border-radius: 10px 10px 0 0
        overflow: hidden
        border-bottom: 3px solid #7877c6
        box-shadow: inset 0 0 50px rgba(0,0,0,0.5)

      .note-bar
        position: absolute
        width: 50px
        background: linear-gradient(180deg,
          rgba(120, 119, 198, 0.3) 0%,
          rgba(120, 119, 198, 0.8) 70%,
          rgba(120, 119, 198, 1) 100%)
        border-radius: 8px
        box-shadow:
          0 0 20px rgba(120, 119, 198, 0.8),
          0 0 40px rgba(120, 119, 198, 0.4),
          inset 0 0 20px rgba(255,255,255,0.2)
        border: 1px solid rgba(120, 119, 198, 0.6)
        animation: note-glow 2s ease-in-out infinite alternate

      .piano-container
        position: relative
        width: 100%
        min-width: 1320px
        height: 150px
        background: rgba(0,0,0,0.8)
        border-radius: 0 0 10px 10px
        box-shadow: inset 0 5px 20px rgba(0,0,0,0.5)
        overflow: visible

      .piano-key
        position: absolute
        bottom: 0
        cursor: pointer
        transition: all 0.1s
        user-select: none

        &.piano-key-white
          width: 60px
          height: 150px
          background: linear-gradient(180deg, #e0e0e5 0%, #c0c0c8 100%)
          border: 2px solid #555
          border-radius: 0 0 8px 8px
          box-shadow: 0 2px 5px rgba(0,0,0,0.3)

          &:hover
            background: linear-gradient(180deg, #d0d0d8 0%, #b0b0b8 100%)

          &.active
            background: linear-gradient(180deg, #7877c6 0%, #5a59a0 100%)
            transform: translateY(3px)
            box-shadow:
              inset 0 2px 8px rgba(0,0,0,0.5),
              0 0 30px rgba(120, 119, 198, 0.8),
              0 0 60px rgba(120, 119, 198, 0.4)

        &.piano-key-black
          width: 36px
          height: 100px
          background: linear-gradient(180deg, #2a2a35 0%, #1a1a25 100%)
          border: 2px solid #000
          border-radius: 0 0 5px 5px
          z-index: 2
          box-shadow: 0 3px 8px rgba(0,0,0,0.6)

          &:hover
            background: linear-gradient(180deg, #3a3a45 0%, #2a2a35 100%)

          &.active
            background: linear-gradient(180deg, #9977ff 0%, #7744ff 100%)
            transform: translateY(2px)
            box-shadow:
              inset 0 2px 8px rgba(0,0,0,0.5),
              0 0 30px rgba(153, 119, 255, 0.8),
              0 0 60px rgba(153, 119, 255, 0.4)

        .key-label
          position: absolute
          bottom: 10px
          left: 50%
          transform: translateX(-50%)
          font-size: 11px
          font-weight: bold
          color: #555
          text-shadow: 0 1px 1px rgba(255,255,255,0.3)

        &.piano-key-black .key-label
          color: #999
          text-shadow: 0 1px 2px rgba(0,0,0,0.5)

      .instructions
        margin-top: 20px
        text-align: center
        font-size: 0.9em
        opacity: 0.7
        color: #b0b0c0

        p
          margin: 5px 0
          text-shadow: 0 0 10px rgba(120, 119, 198, 0.3)

  body
    .container
      h1 Piano Rhythm Game

      .controls
        button#start-btn Start
        button#stop-btn Stop
        button#reset-btn Reset

      .score-display#score-display

      .game-area
        .note-area#note-area
        .piano-container#piano-container

      .instructions
        p 白鍵: Q W E R T Y U I O P [ ] Z X C V B N M , . /
        p 黑鍵: 1 2 4 5 6 8 9 - = A S D F G H
        p 或使用滑鼠/觸控點擊琴鍵

    script(type="module"): :lsc
      # 載入所有元件

      # SoundEngine
      sound-engine = (options = {}) ->
        @ <<<
          type: options.type or 'synth'
          audio-ctx: null
          samples: {}
        @_init-audio-ctx! if options.auto-init
        @

      sound-engine.prototype = Object.create(Object.prototype) <<<
        constructor: sound-engine

        _init-audio-ctx: ->
          return if @audio-ctx
          AudioCtx = window.AudioContext || window.webkitAudioContext
          @audio-ctx = new AudioCtx()

        note-to-freq: (note) ->
          note-map =
            'C4': -9, 'C#4': -8, 'D4': -7, 'D#4': -6
            'E4': -5, 'F4': -4, 'F#4': -3, 'G4': -2
            'G#4': -1, 'A4': 0, 'A#4': 1, 'B4': 2
            'C5': 3, 'C#5': 4, 'D5': 5, 'D#5': 6
            'E5': 7, 'F5': 8, 'F#5': 9, 'G5': 10, 'G#5': 11
            'A5': 12, 'A#5': 13, 'B5': 14
            'C6': 15, 'C#6': 16, 'D6': 17, 'D#6': 18
            'E6': 19, 'F6': 20, 'F#6': 21, 'G6': 22, 'G#6': 23
            'A6': 24, 'A#6': 25, 'B6': 26, 'C7': 27
          semitones = note-map[note]
          return 440 if not semitones?
          440 * Math.pow(2, semitones / 12)

        play-synth: (frequency, duration = 0.3) ->
          @_init-audio-ctx!
          osc = @audio-ctx.createOscillator!
          osc.type = 'sine'
          osc.frequency.value = frequency
          gain = @audio-ctx.createGain!
          gain.gain.value = 0
          osc.connect gain
          gain.connect @audio-ctx.destination
          now = @audio-ctx.currentTime
          gain.gain.setValueAtTime 0, now
          gain.gain.linearRampToValueAtTime 0.3, now + 0.01
          gain.gain.linearRampToValueAtTime 0.2, now + 0.05
          gain.gain.setValueAtTime 0.2, now + duration - 0.05
          gain.gain.linearRampToValueAtTime 0, now + duration
          osc.start now
          osc.stop now + duration

        play-sample: (note, duration = 0.3) ->
          return unless @samples[note]
          @samples[note].currentTime = 0
          @samples[note].play!

        play: (note, duration = 0.3) ->
          freq = @note-to-freq note
          if @type is 'synth'
            @play-synth freq, duration
          else
            @play-sample note, duration

      window.SoundEngine = sound-engine

      # Piano
      piano = (root, options = {}) ->
        @ <<<
          root: root
          sound-engine: options.sound-engine or new SoundEngine!
          on-key-press: options.on-key-press or (->)
          keys: [
            {note: 'C4', key: 'Q', type: 'white', pos: 0}
            {note: 'C#4', key: '1', type: 'black', pos: 0.7}
            {note: 'D4', key: 'W', type: 'white', pos: 1}
            {note: 'D#4', key: '2', type: 'black', pos: 1.8}
            {note: 'E4', key: 'E', type: 'white', pos: 2}
            {note: 'F4', key: 'R', type: 'white', pos: 3}
            {note: 'F#4', key: '4', type: 'black', pos: 3.7}
            {note: 'G4', key: 'T', type: 'white', pos: 4}
            {note: 'G#4', key: '5', type: 'black', pos: 4.75}
            {note: 'A4', key: 'Y', type: 'white', pos: 5}
            {note: 'A#4', key: '6', type: 'black', pos: 5.8}
            {note: 'B4', key: 'U', type: 'white', pos: 6}
            {note: 'C5', key: 'I', type: 'white', pos: 7}
            {note: 'C#5', key: '8', type: 'black', pos: 7.7}
            {note: 'D5', key: 'O', type: 'white', pos: 8}
            {note: 'D#5', key: '9', type: 'black', pos: 8.8}
            {note: 'E5', key: 'P', type: 'white', pos: 9}
            {note: 'F5', key: '[', type: 'white', pos: 10}
            {note: 'F#5', key: '-', type: 'black', pos: 10.7}
            {note: 'G5', key: ']', type: 'white', pos: 11}
            {note: 'G#5', key: '=', type: 'black', pos: 11.75}
            {note: 'A5', key: 'Z', type: 'white', pos: 12}
            {note: 'A#5', key: 'A', type: 'black', pos: 12.8}
            {note: 'B5', key: 'X', type: 'white', pos: 13}
            {note: 'C6', key: 'C', type: 'white', pos: 14}
            {note: 'C#6', key: 'S', type: 'black', pos: 14.7}
            {note: 'D6', key: 'V', type: 'white', pos: 15}
            {note: 'D#6', key: 'D', type: 'black', pos: 15.8}
            {note: 'E6', key: 'B', type: 'white', pos: 16}
            {note: 'F6', key: 'N', type: 'white', pos: 17}
            {note: 'F#6', key: 'F', type: 'black', pos: 17.7}
            {note: 'G6', key: 'M', type: 'white', pos: 18}
            {note: 'G#6', key: 'G', type: 'black', pos: 18.75}
            {note: 'A6', key: ',', type: 'white', pos: 19}
            {note: 'A#6', key: 'H', type: 'black', pos: 19.8}
            {note: 'B6', key: '.', type: 'white', pos: 20}
            {note: 'C7', key: '/', type: 'white', pos: 21}
          ]
          key-map: {}
          active-keys: {}
        for key-info in @keys
          @key-map[key-info.key] = key-info.note
        @init!
        @

      piano.prototype = Object.create(Object.prototype) <<<
        constructor: piano
        init: ->
          @render!
          @setup-events!
        render: ->
          @root.innerHTML = ""
          @root.className = 'piano-container'
          for key-info in @keys
            key-el = document.createElement 'div'
            key-el.className = "piano-key piano-key-#{key-info.type}"
            key-el.dataset.note = key-info.note
            key-el.dataset.key = key-info.key
            key-el.style.left = "#{key-info.pos * 60}px"
            label = document.createElement 'span'
            label.className = 'key-label'
            label.textContent = key-info.key
            key-el.appendChild label
            @root.appendChild key-el
        setup-events: ->
          document.addEventListener 'keydown', (e) ~> @on-keydown.apply @, [e]
          document.addEventListener 'keyup', (e) ~> @on-keyup.apply @, [e]
          keys = @root.querySelectorAll '.piano-key'
          for key-el in keys
            key-el.addEventListener 'mousedown', (e) ~> @on-mouse-down.apply @, [e]
            key-el.addEventListener 'touchstart', (e) ~> @on-touch-start.apply @, [e]
          document.addEventListener 'mouseup', (e) ~> @release-all-keys!
          document.addEventListener 'touchend', (e) ~> @release-all-keys!
        on-keydown: (e) ->
          return if e.repeat
          key = e.key.toUpperCase!
          note = @key-map[key]
          return unless note
          @press-key note
        on-keyup: (e) ->
          key = e.key.toUpperCase!
          note = @key-map[key]
          return unless note
          @release-key note
        on-mouse-down: (e) ->
          e.preventDefault!
          note = e.currentTarget.dataset.note
          @press-key note
        on-touch-start: (e) ->
          e.preventDefault!
          note = e.currentTarget.dataset.note
          @press-key note
        press-key: (note) ->
          return if @active-keys[note]
          @active-keys[note] = true
          key-el = @root.querySelector "[data-note='#{note}']"
          key-el?.classList.add 'active' if key-el
          @sound-engine.play note, 0.3
          @on-key-press note
        release-key: (note) ->
          return unless @active-keys[note]
          delete @active-keys[note]
          key-el = @root.querySelector "[data-note='#{note}']"
          key-el?.classList.remove 'active' if key-el
        release-all-keys: ->
          for note of @active-keys
            @release-key note

      window.Piano = piano

      # NoteManager
      note-manager = (root, options = {}) ->
        @ <<<
          root: root
          speed: options.speed or 200
          fall-distance: 500
          notes: []
          active-notes: []
          note-elements: []
          start-time: null
          is-playing: false
          on-note-hit: options.on-note-hit or (->)
        @fall-time = @fall-distance / @speed * 1000
        @init!
        @

      note-manager.prototype = Object.create(Object.prototype) <<<
        constructor: note-manager
        init: ->
          @root.className = 'note-area'
        load-song: (song-data) ->
          @notes = song-data.notes or []
          @title = song-data.title or 'Untitled'
          @bpm = song-data.bpm or 120
        start: ->
          return if @is-playing
          @is-playing = true
          @start-time = Date.now!
          @update!
        stop: ->
          @is-playing = false
          @clear-notes!
        reset: ->
          @stop!
          @active-notes = []
          @note-elements = []
          @clear-notes!
          for note in @notes
            note.spawned = false
            note.hit-checked = false
        clear-notes: ->
          @root.innerHTML = ""
          @note-elements = []
        update: ->
          return unless @is-playing
          current-time = Date.now! - @start-time
          @spawn-notes current-time
          @update-notes current-time
          requestAnimationFrame ~> @update!
        spawn-notes: (current-time) ->
          for note in @notes
            spawn-time = note.time - @fall-time
            if current-time >= spawn-time and not note.spawned
              @create-note-element note
              note.spawned = true
              @active-notes.push note
        create-note-element: (note) ->
          el = document.createElement 'div'
          el.className = 'note-bar'
          el.dataset.note = note.key
          key-pos = @get-key-position note.key
          el.style.left = "#{key-pos + 5}px"
          height = note.duration / 1000 * @speed
          el.style.height = "#{height}px"
          el.style.top = "0px"
          @root.appendChild el
          @note-elements.push {el: el, note: note}
        update-notes: (current-time) ->
          i = @note-elements.length
          while i--
            item = @note-elements[i]
            note = item.note
            el = item.el
            elapsed = current-time - (note.time - @fall-time)
            y = elapsed / @fall-time * @fall-distance
            el.style.top = "#{y}px"
            if y >= @fall-distance and not note.hit-checked
              note.hit-checked = true
              @on-note-hit note
            if y > @fall-distance + 100
              @root.removeChild el
              @note-elements.splice i, 1
        get-key-position: (note-key) ->
          key-map =
            'C4': 0, 'C#4': 0.7, 'D4': 1, 'D#4': 1.8
            'E4': 2, 'F4': 3, 'F#4': 3.7, 'G4': 4
            'G#4': 4.75, 'A4': 5, 'A#4': 5.8, 'B4': 6
            'C5': 7, 'C#5': 7.7, 'D5': 8, 'D#5': 8.8
            'E5': 9, 'F5': 10, 'F#5': 10.7, 'G5': 11, 'G#5': 11.75
            'A5': 12, 'A#5': 12.8, 'B5': 13
            'C6': 14, 'C#6': 14.7, 'D6': 15, 'D#6': 15.8
            'E6': 16, 'F6': 17, 'F#6': 17.7, 'G6': 18, 'G#6': 18.75
            'A6': 19, 'A#6': 19.8, 'B6': 20, 'C7': 21
          pos = key-map[note-key] or 0
          pos * 60
        get-current-time: ->
          return 0 unless @start-time
          Date.now! - @start-time

      window.NoteManager = note-manager

      # Game
      game = (options = {}) ->
        @ <<<
          piano-root: options.piano-root
          note-root: options.note-root
          score-root: options.score-root
          sound-engine: null
          piano: null
          note-manager: null
          score: 0
          combo: 0
          max-combo: 0
          perfect-count: 0
          good-count: 0
          miss-count: 0
          pending-judgments: []
        @init!
        @

      game.prototype = Object.create(Object.prototype) <<<
        constructor: game
        init: ->
          @sound-engine = new SoundEngine {auto-init: false}
          @piano = new Piano @piano-root, {
            sound-engine: @sound-engine
            on-key-press: (note) ~> @on-key-press.apply @, [note]
          }
          @note-manager = new NoteManager @note-root, {
            speed: 200
            on-note-hit: (note) ~> @on-note-hit.apply @, [note]
          }
        load-song: (song-data) ->
          @note-manager.load-song song-data
        start: ->
          @reset-score!
          @note-manager.start!
          @update-score-display!
        stop: ->
          @note-manager.stop!
        reset: ->
          @stop!
          @note-manager.reset!
          @reset-score!
        reset-score: ->
          @score = 0
          @combo = 0
          @max-combo = 0
          @perfect-count = 0
          @good-count = 0
          @miss-count = 0
          @pending-judgments = []
          @update-score-display!
        on-note-hit: (note) ->
          @pending-judgments.push {
            note: note
            hit-time: @note-manager.get-current-time!
            judged: false
          }
        on-key-press: (pressed-note) ->
          current-time = @note-manager.get-current-time!
          best-match = null
          best-diff = Infinity
          for judgment in @pending-judgments
            continue if judgment.judged
            continue if judgment.note.key != pressed-note
            diff = Math.abs(current-time - judgment.note.time)
            if diff < best-diff
              best-diff = diff
              best-match = judgment
          if best-match
            @judge-hit best-match, best-diff
        judge-hit: (judgment, time-diff) ->
          judgment.judged = true
          if time-diff <= 50
            @add-score 'perfect'
            @show-judgment 'PERFECT'
            @show-hit-effect judgment.note.key, 'perfect'
          else if time-diff <= 100
            @add-score 'good'
            @show-judgment 'GOOD'
            @show-hit-effect judgment.note.key, 'good'
          else
            @add-score 'miss'
            @show-judgment 'MISS'
        add-score: (type) ->
          switch type
          | 'perfect' =>
            @perfect-count++
            @combo++
            @score += 100 * (1 + @combo * 0.1)
          | 'good' =>
            @good-count++
            @combo++
            @score += 50
          | 'miss' =>
            @miss-count++
            @combo = 0
          @max-combo = Math.max @max-combo, @combo
          @update-score-display!
        show-judgment: (text) ->
          return unless @score-root
          judgment-el = document.createElement 'div'
          judgment-el.className = "judgment judgment-#{text.toLowerCase!}"
          judgment-el.textContent = text
          @score-root.appendChild judgment-el
          setTimeout ->
            judgment-el?.remove!
          , 500
        show-hit-effect: (note-key, type) ->
          return unless @piano-root
          key-el = @piano-root.querySelector "[data-note='#{note-key}']"
          return unless key-el
          rect = key-el.getBoundingClientRect!
          parent-rect = @piano-root.getBoundingClientRect!
          x = rect.left - parent-rect.left + rect.width / 2
          y = rect.top - parent-rect.top
          # 光圈爆炸特效
          burst = document.createElement 'div'
          burst.className = 'hit-effect'
          burst.style.left = "#{x - 40}px"
          burst.style.top = "#{y - 40}px"
          @piano-root.appendChild burst
          setTimeout ->
            burst?.remove!
          , 600
          # 粒子特效
          for i from 0 to 7
            particle = document.createElement 'div'
            particle.className = 'hit-particle'
            angle = (i / 8) * Math.PI * 2
            distance = 40 + Math.random! * 20
            particle.style.left = "#{x}px"
            particle.style.top = "#{y}px"
            @piano-root.appendChild particle
            do (particle, angle, distance) ->
              setTimeout ->
                particle.style.transition = 'all 0.5s ease-out'
                particle.style.opacity = '0'
                particle.style.transform = "translate(#{Math.cos(angle) * distance}px, #{Math.sin(angle) * distance}px)"
              , 10
              setTimeout ->
                particle?.remove!
              , 520
        update-score-display: ->
          return unless @score-root
          @score-root.innerHTML = """
            <div class="score-item">Score: #{Math.floor @score}</div>
            <div class="score-item">Combo: #{@combo}</div>
            <div class="score-item">
              <span class="perfect">Perfect: #{@perfect-count}</span> /
              <span class="good">Good: #{@good-count}</span> /
              <span class="miss">Miss: #{@miss-count}</span>
            </div>
          """

      window.Game = game

      # 初始化遊戲
      my-game = new Game {
        piano-root: document.getElementById 'piano-container'
        note-root: document.getElementById 'note-area'
        score-root: document.getElementById 'score-display'
      }

      # 載入樂譜
      fetch '/assets/data/songs/demo.json'
        .then (res) -> res.json!
        .then (data) -> my-game.load-song data

      # 按鈕事件
      document.getElementById('start-btn').addEventListener 'click', ->
        my-game.start!

      document.getElementById('stop-btn').addEventListener 'click', ->
        my-game.stop!

      document.getElementById('reset-btn').addEventListener 'click', ->
        my-game.reset!
